# Real-time System & Environmental Monitoring Server

Backend server untuk monitoring sistem dan lingkungan real-time menggunakan Golang, Echo framework, dan Supabase.

## Fitur Utama

- **Comprehensive System Metrics**: CPU, Memory, Disk, Network, Process, Load Average
- **Environmental Monitoring**: Temperature & Humidity dari sensor (stored in Supabase)
- **Thermal Monitoring**: CPU temperature sensors
- **Network Details**: Per-interface statistics, connection states
- **Process Information**: Running, sleeping, zombie processes
- **RESTful API**: Single endpoint untuk semua metrics

## Teknologi yang Digunakan

- **Golang** v1.25+
- **Echo** v5 - Web framework
- **Supabase** - Database untuk environmental metrics
- **gopsutil** v3 - System and process metrics
- **godotenv** - Environment variables management

## Setup

### 1. Prerequisites

- Golang 1.25 atau lebih baru
- Akun Supabase
- Git

### 2. Clone & Install Dependencies

```bash
cd server
go mod download
```

### 3. Setup Environment Variables

Copy file `.env.example` menjadi `.env`:

```bash
cp .env.example .env
```

Edit file `.env` dengan kredensial Supabase Anda:

```env
PORT=8080
ENV=development
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_KEY=your_supabase_anon_key_here
```

### 4. Setup Database (Supabase)

Buat tabel `env_metrics` di Supabase dengan schema berikut:

```sql
CREATE TABLE public.env_metrics (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
  first_temperature NUMERIC NULL,
  first_humidity NUMERIC NULL,
  second_temperature NUMERIC NULL,
  second_humidity NUMERIC NULL,
  CONSTRAINT env_metrics_pkey PRIMARY KEY (id)
) TABLESPACE pg_default;

-- Index untuk query yang lebih cepat
CREATE INDEX idx_env_metrics_created_at ON env_metrics(created_at DESC);
```

### 5. Run Server

```bash
go run main.go
```

Server akan berjalan di `http://localhost:8080`

## API Endpoints

### Health Check

```http
GET /health
```

**Response:**
```json
{
  "status": "ok"
}
```

---

### WebSocket Terminal

Interactive shell terminal melalui WebSocket.

```
WS /api/v1/terminal
```

**WebSocket Message Format:**

Client → Server:
```json
{
  "type": "input",
  "data": "ls -la\n"
}
```

Server → Client:
```json
{
  "type": "output",
  "data": "total 48\ndrwxr-xr-x 12 user user 4096 Feb  3 10:30 .\n",
  "session": "20260203103045-abc123"
}
```

**Message Types:**

Client Messages:
- `input` - Send command to terminal
- `ping` - Keep connection alive
- `close` - Close terminal session

Server Messages:
- `connected` - Connection established
- `output` - Terminal stdout
- `error` - Terminal stderr
- `pong` - Response to ping

**Example Usage (JavaScript):**

```javascript
const ws = new WebSocket('ws://localhost:8080/api/v1/terminal');

ws.onopen = () => {
  console.log('Terminal connected');
};

ws.onmessage = (event) => {
  const msg = JSON.parse(event.data);
  
  if (msg.type === 'connected') {
    console.log('Session:', msg.session);
    // Send command
    ws.send(JSON.stringify({
      type: 'input',
      data: 'echo "Hello from terminal"\n'
    }));
  } else if (msg.type === 'output') {
    console.log('Output:', msg.data);
  } else if (msg.type === 'error') {
    console.error('Error:', msg.data);
  }
};

ws.onerror = (error) => {
  console.error('WebSocket error:', error);
};

ws.onclose = () => {
  console.log('Terminal disconnected');
};

// Close terminal when done
setTimeout(() => {
  ws.send(JSON.stringify({ type: 'close' }));
  ws.close();
}, 10000);
```

**Session Management:**
- Sessions auto-cleanup after 30 minutes of inactivity
- Each WebSocket connection gets a unique session ID
- Sessions run in isolated shell processes
- Supports multiple concurrent connections

---

### Get System Metrics

Endpoint tunggal untuk mendapatkan **semua metrics** sistem dan environmental data.

```http
GET /api/v1/system-metrics
```

**Response Structure:**

```json
{
  "success": true,
  "message": "System metrics retrieved successfully",
  "data": {
    "timestamp": "2026-01-20T10:30:00Z",
    
    "environment": {
      "id": 100,
      "created_at": "2026-01-20T10:29:55Z",
      "first_temperature": 25.5,
      "first_humidity": 60.0,
      "second_temperature": 26.0,
      "second_humidity": 58.5
    },
    
    "cpu": {
      "usage_percent": 45.5,
      "per_core": [42.0, 48.0, 45.0, 46.5, 44.0, 47.0, 43.5, 48.5],
      "cores": 8,
      "threads": 8,
      "model_name": "AMD Ryzen 5 3550H with Radeon Vega Mobile Gfx",
      "frequency_mhz": 2600.0,
      "user_percent": 25.5,
      "system_percent": 15.0,
      "idle_percent": 59.5
    },
    
    "memory": {
      "total": 17179869184,
      "available": 10737418240,
      "used": 6442450944,
      "free": 10737418240,
      "used_percent": 37.5,
      "cached": 4294967296,
      "buffers": 536870912,
      "swap": {
        "total": 2147483648,
        "used": 0,
        "free": 2147483648,
        "used_percent": 0.0
      }
    },
    
    "disk": [
      {
        "device": "/dev/nvme0n1p2",
        "mount_point": "/",
        "fs_type": "ext4",
        "total": 512110190592,
        "used": 256055095296,
        "free": 256055095296,
        "used_percent": 50.0,
        "inodes_total": 31211520,
        "inodes_used": 1234567,
        "inodes_free": 29976953
      },
      {
        "device": "/dev/nvme0n1p1",
        "mount_point": "/boot",
        "fs_type": "vfat",
        "total": 536870912,
        "used": 134217728,
        "free": 402653184,
        "used_percent": 25.0
      }
    ],
    
    "network": {
      "bytes_sent": 1234567890,
      "bytes_recv": 9876543210,
      "packets_sent": 1234567,
      "packets_recv": 9876543,
      "errors_in": 0,
      "errors_out": 0,
      "drop_in": 0,
      "drop_out": 0,
      "interfaces": [
        {
          "name": "wlan0",
          "bytes_sent": 1234567890,
          "bytes_recv": 9876543210,
          "packets_sent": 1234567,
          "packets_recv": 9876543,
          "addrs": ["192.168.1.100/24", "fe80::1234:5678:9abc:def0/64"],
          "mtu": 1500
        },
        {
          "name": "lo",
          "bytes_sent": 12345678,
          "bytes_recv": 12345678,
          "packets_sent": 12345,
          "packets_recv": 12345,
          "addrs": ["127.0.0.1/8", "::1/128"],
          "mtu": 65536
        }
      ],
      "connections": {
        "established": 25,
        "listen": 15,
        "time_wait": 5,
        "close_wait": 2,
        "total": 47
      }
    },
    
    "process": {
      "total": 325,
      "running": 2,
      "sleeping": 320,
      "stopped": 0,
      "zombie": 0,
      "threads": 1450
    },
    
    "load": {
      "load1": 1.25,
      "load5": 1.45,
      "load15": 1.30
    },
    
    "temperature": {
      "cpu_temp": 55.0,
      "sensors": [
        {
          "name": "k10temp",
          "temperature": 55.0,
          "high": 70.0,
          "critical": 95.0
        },
        {
          "name": "nvme",
          "temperature": 45.0,
          "high": 80.0,
          "critical": 85.0
        }
      ]
    },
    
    "system": {
      "hostname": "server-01",
      "os": "linux",
      "platform": "ubuntu",
      "platform_family": "debian",
      "platform_version": "22.04",
      "kernel_version": "5.15.0-76-generic",
      "kernel_arch": "x86_64",
      "virtualization": "",
      "uptime": 86400,
      "boot_time": 1705750000,
      "processes": 325
    }
  }
}
```

### Field Descriptions

#### Environment (dari database)
- `first_temperature` / `second_temperature`: Suhu dalam Celsius dari sensor 1 & 2
- `first_humidity` / `second_humidity`: Kelembaban dalam % dari sensor 1 & 2

#### CPU
- `usage_percent`: Total CPU usage (0-100%)
- `per_core`: Array CPU usage per core
- `cores`: Jumlah physical cores
- `threads`: Jumlah logical processors
- `frequency_mhz`: CPU frequency dalam MHz
- `user_percent`: CPU time in user mode
- `system_percent`: CPU time in kernel mode
- `idle_percent`: CPU idle time

#### Memory
- `total`: Total RAM (bytes)
- `available`: Available memory (bytes)
- `used`: Used memory (bytes)
- `used_percent`: Memory usage percentage
- `cached`: Cached memory (bytes)
- `buffers`: Buffer memory (bytes)
- `swap`: Swap memory metrics

#### Disk
Array of all mounted partitions:
- `device`: Device name
- `mount_point`: Where it's mounted
- `fs_type`: Filesystem type (ext4, ntfs, etc)
- `used_percent`: Disk usage percentage
- `inodes_*`: Inode information

#### Network
- `bytes_sent/recv`: Total bytes transferred
- `packets_sent/recv`: Total packets transferred
- `errors_*`: Network errors
- `drop_*`: Dropped packets
- `interfaces`: Per-interface statistics dengan IP addresses
- `connections`: TCP connection states

#### Process
- `total`: Total processes
- `running`: Currently running
- `sleeping`: Sleeping processes
- `zombie`: Zombie processes
- `threads`: Total threads

#### Load
- `load1/5/15`: Load average untuk 1, 5, dan 15 menit

#### Temperature
- `cpu_temp`: Main CPU temperature
- `sensors`: Array of all thermal sensors

#### System
- `hostname`: System hostname
- `os`: Operating system
- `platform`: OS distribution
- `kernel_version`: Kernel version
- `uptime`: System uptime (seconds)
- `boot_time`: Boot timestamp (Unix)

---

## Response Format

Semua response mengikuti format standar:

### Success Response

```json
{
  "success": true,
  "message": "Operation successful",
  "data": { ... }
}
```

### Error Response

```json
{
  "success": false,
  "message": "Error message",
  "error": "Detailed error description"
}
```

## Development

### Build

```bash
go build -o bin/server main.go
```

### Run Binary

```bash
./bin/server
```

### Run with Hot Reload (using Air)

Install Air:
```bash
go install github.com/air-verse/air@latest
```

Create `.air.toml`:
```toml
root = "."
tmp_dir = "tmp"

[build]
cmd = "go build -o ./tmp/main ."
bin = "tmp/main"
include_ext = ["go"]
exclude_dir = ["tmp", "vendor"]
```

Run with Air:
```bash
air
```

## Example Usage

### cURL

```bash
# Get all metrics
curl http://localhost:8080/api/v1/system-metrics | python3 -m json.tool

# Health check
curl http://localhost:8080/health
```

### JavaScript/Fetch

```javascript
async function getSystemMetrics() {
  const response = await fetch('http://localhost:8080/api/v1/system-metrics');
  const data = await response.json();
  
  if (data.success) {
    console.log('CPU Usage:', data.data.cpu.usage_percent + '%');
    console.log('Memory Usage:', data.data.memory.used_percent + '%');
    console.log('Environment Temp 1:', data.data.environment?.first_temperature + '°C');
  }
  
  return data;
}

// Poll every 5 seconds
setInterval(getSystemMetrics, 5000);
```

### Python

```python
import requests
import time

def get_metrics():
    response = requests.get('http://localhost:8080/api/v1/system-metrics')
    data = response.json()
    
    if data['success']:
        metrics = data['data']
        print(f"CPU: {metrics['cpu']['usage_percent']:.1f}%")
        print(f"Memory: {metrics['memory']['used_percent']:.1f}%")
        print(f"Disk: {metrics['disk'][0]['used_percent']:.1f}%")
        
        if metrics.get('environment'):
            env = metrics['environment']
            print(f"Temp 1: {env['first_temperature']}°C")
            print(f"Humidity 1: {env['first_humidity']}%")

# Poll every 5 seconds
while True:
    get_metrics()
    time.sleep(5)
```

## Architecture

Project menggunakan **Clean Architecture**:

```
internal/
├── config/          # Configuration & Supabase setup
├── domain/          # Entities & domain models
├── repository/      # Data access layer
│   └── supabase/   # Supabase implementation
├── delivery/http/   # HTTP layer
│   ├── handler/    # Request handlers
│   ├── middleware/ # HTTP middleware
│   └── router.go   # Route definitions
└── pkg/            # Shared utilities
    ├── response/   # Response formatter
    └── validator/  # Request validator
```

## License

MIT License
